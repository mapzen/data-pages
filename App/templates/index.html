{% extends "layout.html" %}

{% block styles %}
  body.data-pages {
    margin-top: 0;
  }
  h1 {
    margin-bottom: 10px;
  }
  .column-map {
    position: fixed;
  }
  .column-text {
    float: right;
  }
  body.data-pages #search_input{
    height:41px;
  }
  body.data-pages .inline-submit .btn { 
    background: #666; 
    color: white;
  }
  body.data-pages .inline-submit .btn:hover { 
    background: #555; 
  }

  #map {
    border-right: 1px solid rgb(224,224,224);
  }
  #map path {
    fill: #d4645c;
    stroke: #d4645c;
    stroke-width: 2;
    stroke-opacity: .3;
    fill-opacity: .3;
  }
  #map path.blue {
    fill: #6ea0a4;
    stroke: #6ea0a4;
  }
  #map path.outline {
    stroke: #000;
    fill: #6ea0a4;
    fill-opacity: .3;
    stroke-opacity: .5;
  }
  .drag-icon {
    width: 10px;
    height: 10px;
    cursor: nesw-resize;
    border-color: #aaa;
  }
  .drag-icon:nth-child(even) {
    border-top: 3px solid;
    border-right: 3px solid;
  }
  .drag-icon:nth-child(odd) {
    border-bottom: 3px solid;
    border-left: 3px solid;
  }
  .drag-icon:hover {
    border-color: #666;
  }
  .leaflet-container a {
    color: #6ea0a4;
  }
  .leaflet-container .leaflet-control-zoom-in,
  .leaflet-container .leaflet-control-zoom-out {
    color: #000;
  }

  #search-box {
    margin: 20px 0 40px;
  }
  .data-filter-label {
    position:relative;
    font-size:12px;
    line-height:1;
    font-weight:bold;
    color:#000;
    text-transform:uppercase;
    width: 100%;
  }
  #extracts {
    margin-bottom: 50px;
  }
  .country {
    border-top: 1px solid rgb(224,224,224);
    margin-top: 20px;
  }
  .country-name {
    background: rgb(224,224,224);
    font-weight: bold;
    text-transform: uppercase;
    display: inline-block;
    letter-spacing: 1px;
    padding: 2px 10px;
    font-size: 12px;
    cursor: pointer;
    float: left;
  }
  .country-name:hover {
    background: #ccc;
  }
  .city {
    margin: 3px 0 3px 10px;
    cursor: pointer;
    clear: both;
    color: #000;
    font-weight: normal;
    display: block;
  }
  .city:hover {
    text-decoration: underline;
  }
  #did-you-mean {
    display: none;
  }
  #did-you-mean .name {
    font-weight: bold;
    color: #6ea0a4;
    cursor: pointer;
  }
  #make-request {
    display: none;
    background: rgba(110,160,164,.3);
    padding: 20px;
  }
  #make-request .btn:hover {
    background: rgba(110,160,164,.4);
  }
  #request-wrapper .request-messaging {
    display: none;
  }
  #request-wrapper.default .default-request-text {
    display: block;
  }
  #request-wrapper.encompassed .encompassed-text {
    display: block;
  }
  #request-wrapper.request-greater-1 .request-greater-1 {
    display: block;
  }
  #request-wrapper.request-greater-5 .request-greater-5 {
    display: block;
  }
  #request-wrapper.request-greater-5 #make-request {
    background: rgba(212,100,92, .3);
  }
  #request-wrapper.request-greater-5 .btn {
    display: none;
  }
  .autocomplete {
    border: 1px solid #ddd;
  }
  .suggestion {
    border-bottom: 1px solid #ddd;
    padding: 1px 0 1px 15px;
    color: #808080;
    cursor: pointer;
  }
  .suggestion.selected {
    color: #000;
    background: #ddd;
  }
  .suggestion:hover {
    color: #000;
    background: #eee;
  }
  .suggestion:last-child {
    margin-bottom: -1px;
  }
  @media (max-width: 768px) {
    .column-map {
      position: relative;
    }
  }
{% endblock %}

{% block content %}
  <div class='container-fluid'>
    <div class='col-xs-12 col-sm-6 column-map'>
      <div id='map'></div>
    </div>
    <div class='col-xs-12 col-sm-6 column-text'>
      <h1 class="headroom text-center">metro extracts</h1>
      <p>Now itâ€™s even easier to get local data so you can start building cool stuff. Each week, we automatically extract the latest <a href='http://openstreetmap.org/'>OpenStreetMap</a> data into manageable, metro-area shapefiles in a variety of formats for you to use.</p>
      <p>
        <a href="https://mapzen.com/documentation/metro-extracts/">Documentation</a> |
        <a href="https://mapzen.com/documentation/metro-extracts/walkthrough/">Tutorial</a> |
        <a href="https://mapzen.com/documentation/metro-extracts/overview/#choose-a-file-format">File Format Guide</a>
      </p>
      <div class='row inline-submit' id='search-box'>
        <label class='data-filter-label' for='search_input'>Filter Extracts by City or Region</label>
        <input type='search' class='hasclear col-sm-9 col-xs-8' id='search_input' placeholder='example: Los Angeles' type='text'>
        <input id='search_submit' type="submit" value="search" class="col-xs-4 col-sm-3 btn btn-transparent">
        <div class="autocomplete"></div>
      </div>
      <div id="request-wrapper">
        <p id="did-you-mean">Did you mean <span class="name"></span>?</p>
        <p class="encompassed-text request-messaging">Your extract is included inside of a larger area: </p>
        <div id="extracts">
          {% for country_metros in metros_tree %}
            <div class="country">
              <div class="country-name">{{ country_metros.country }}</div>
              {% for metro in country_metros.metros %}
                <a class="city" href="{{ metro.href }}">{{ metro.name }}</a>
              {% endfor %}
            </div>
          {% endfor %}
        </div>
        <div id="make-request">
          <p class="default-request-text request-messaging">Hmm, we don't have an extract for <span class="name"></span> yet. Would you like to request one?</p>
          <p class="encompassed-text request-messaging">If you'd like to request an extract specifically for <span class="name"></span>, click the button below. Please note, this can take a few hours to process.</p>
          <p class="request-greater-1 request-messaging">We don't have a request for <span class="name"></span> yet, you can request one by clicking the button below. Please note, you have requested a large area and this request will take more than a few hours to process.</p>
          <p class="request-greater-5 request-messaging">Sorry, but your request for <span class="name"></span> is too large to prcoess. Please make your request a smaller area.</p>
          <form action="{{ url_for('ODES.post_envelope') }}" method="post">
            <input name="bbox_n" type="hidden" />
            <input name="bbox_w" type="hidden" />
            <input name="bbox_s" type="hidden" />
            <input name="bbox_e" type="hidden" />
            <input name="wof_id" type="hidden" />
            <button class="btn btn-transparent">Create <span class="name"></span> Request</button>
          </form>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block script %}
  var nestedCities = {{metros_tree|tojson|safe}},
    extractLayers = [],
    mapHeight = window.innerWidth < 768 ? 300 : window.innerHeight;

  d3.select("#map").style("height", mapHeight + 'px');

  function hasWebGL () {
    try {
      var canvas = document.createElement('canvas')
      return !!(window.WebGLRenderingContext && (canvas.getContext('webgl') || canvas.getContext('experimental-webgl')))
    } catch (x) {
      return false
    }
  }
  function initDisplayMap (geoJSONUrl) {
    var southwest = L.latLng(0, -125),
      northeast = L.latLng(0, 125),
      options = {
      scrollWheelZoom: false,
      // Disables dragging on touch-detected devices
      dragging: (window.self !== window.top && L.Browser.touch) ? false : true,
      tap: (window.self !== window.top && L.Browser.touch) ? false : true,
    };
    var displayMap = L.map('map', options).fitBounds(L.latLngBounds(southwest, northeast));
    var layer;

    if (hasWebGL() === true) {
      layer = Tangram.leafletLayer({
        scene: '{{ url_for('static', filename='scene.yaml') }}',
        attribution: '<a href="https://mapzen.com/tangram">Tangram</a> | &copy; OSM contributors | <a href="https://mapzen.com/">Mapzen</a>'
      });
    } else {
      layer = L.tileLayer('https://stamen-tiles.a.ssl.fastly.net/toner-lite/{z}/{x}/{y}.png', {
        attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, under <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a>. Data by <a href="http://openstreetmap.org">OpenStreetMap</a>, under <a href="http://www.openstreetmap.org/copyright">ODbL</a>.',
      });
    }
    layer.addTo(displayMap);

    d3.json(geoJSONUrl, function(data){
      L.geoJson(data, { onEachFeature: onEachFeature }).addTo(displayMap);
    });

    return displayMap;
  }
  var mapurl = '{{ url_for('Metro-Extracts.get_cities_geojson') }}';

  var onEachFeature = function (feature, layer) {
    extractLayers.push(layer);
    layer.bindPopup("<a href='"+feature.properties.href+"'>"+feature.properties.display_name+"</a>");
  }

  // Setup map
  var displayMap = initDisplayMap(mapurl);

  d3.selectAll(".country-name")
    .on("click",function(d){
      doSearch(d3.select(this).text());
    });

  function drawList(data, request_id, display_name) {
    var countries = d3.select("#extracts").selectAll(".country").data(data);
    var enterCountries = countries.enter().append("div").attr("class","country");
    countries.exit().remove();
    enterCountries.append("div").attr("class","country-name")
    countries.select(".country-name")
      .text(function(d){ return d.country; })
      .on("click",function(d){
        doSearch(d.country);
      });
    var cities = countries.selectAll(".city").data(function(d){ return d.metros; });
    cities.enter().append("a").attr("class","city");
    cities.text(function(d){ return d.name; })
      .attr("href",function(d){ return d.href + (request_id ? escape(request_id)+"/"+escape(display_name) : ""); });
    cities.exit().remove();
  }

  var xhr;

  function doSuggestion(query) {
    if (xhr) xhr.abort();
    xhr = d3.json("https://search.mapzen.com/v1/autocomplete?text="+query+"&sources=wof&api_key=search-owZDPeC", function(error, json) {
      if (json.features.length)
        showSuggestions(json);
    });
  }

  function showSuggestions(data) {
    var suggestion = d3.select(".autocomplete")
      .selectAll(".suggestion").data(data.features);
    suggestion.enter().append("div").attr("class","suggestion");
    suggestion.exit().remove();
    suggestion.text(function(d){ return d.properties.label; })
      .on("click",function(d){
        placeID = d.properties.source + ":" + d.properties.layer + ":" + d.properties.id;
        onSubmit(d.properties.label);
      });
  }

  function doSearch(query) {
    d3.selectAll(".suggestion").remove();

    if (placeID) {
      d3.json("https://search.mapzen.com/v1/place?api_key=search-owZDPeC&ids="+placeID, function(error, json){
        var bbox = json.features[0].bbox;
        displayMap.fitBounds([[bbox[1],bbox[0]],[bbox[3], bbox[2]]]).zoomOut(1);
        requestExtract(json.features[0]);
      });
    } else {
      d3.json("https://search.mapzen.com/v1/search?text="+query+"&sources=wof&api_key=search-owZDPeC", function(error, json) {
        if (json.features[0].properties.label.toLowerCase().indexOf(query.toLowerCase()) == -1) {
          suggestExtract(json.features[0]);
          return;
        }
        
        var bbox = json.features[0].bbox;
        displayMap.fitBounds([[bbox[1],bbox[0]],[bbox[3], bbox[2]]]).zoomOut(1);
        if (d3.selectAll(".city")[0].length == 0){
          document.getElementById("search_input").value = json.features[0].properties.label;
          requestExtract(json.features[0]);
        } else {
          clearRequest();
        }
      });
    }
  }

  Number.prototype.toRad = function() {
     return this * Math.PI / 180;
  }
  Number.prototype.toDeg = function() {
     return this * 180 / Math.PI;
  }

  function calculateOffset(theta, d, lat1, lng1) {
    var lat1 = lat1.toRad(), 
      lng1 = lng1.toRad(),
      R = 6371;

    var lat2 = Math.asin( Math.sin(lat1)*Math.cos(d/R) 
          + Math.cos(lat1)*Math.sin(d/R)*Math.cos(theta) ),
      lng2 = lng1 + Math.atan2(Math.sin(theta)*Math.sin(d/R)*Math.cos(lat1), 
            Math.cos(d/R)-Math.sin(lat1)*Math.sin(lat2));

    return [lat2.toDeg(), lng2.toDeg()];
  }

  function calculateNewBox(bbox) {
    var distance = Math.sqrt(Math.pow(bbox[3]-bbox[1],2) + Math.pow(bbox[2]-bbox[0], 2))*25,
      northEast = calculateOffset(-Math.PI*3/4, distance, bbox[1], bbox[0]),
      southWest = calculateOffset(Math.PI/4, distance, bbox[3], bbox[2]);
    return [northEast, southWest];
  }

  function suggestExtract(metro) {
    d3.select("#did-you-mean").style("display","block")
      .select(".name").text(metro.properties.label)
      .on("click",function(){
        d3.select(this.parentNode).style("display","none");
        var bbox = metro.bbox;
        displayMap.fitBounds([[bbox[1],bbox[0]],[bbox[3], bbox[2]]]).zoomOut(1);
        document.getElementById("search_input").value = metro.properties.label;
        filterList(metro.properties.label);
        requestExtract(metro);
      });
    d3.select("#make-request").style("display","none");
  }

  var rect, 
    dots = [],
    outline,
    requestBoundingBox;
  var myIcon = L.divIcon({className: 'drag-icon'});
  //var wof = "http://whosonfirst.mapzen.com/spelunker/id/";
  var wof = "/wof/";

  function requestExtract(metro) {
    var geoID = metro.properties.id;
    d3.select("input[name='wof_id']").attr("value",geoID);

    requestBoundingBox = calculateNewBox(metro.bbox);

    drawRequestBox();

    d3.json(wof+geoID+".geojson",function(data){
      outline = L.geoJson(data.geometry, { className : "outline" }).addTo(displayMap);
      displayMap.addLayer(outline);
    });

    var bbox = metro.bbox,
      p1 = L.latLng(bbox[1],bbox[0]),
      p2 = L.latLng(bbox[3],bbox[2]);
    var encompassed = [{
      country : "Encompassing Metros",
      metros : []
    }];
    extractLayers.forEach(function(l){
      if (l.getBounds().contains(p1) && l.getBounds().contains(p2)) 
        encompassed[0].metros.push({
          name : l.feature.properties.display_name,
          href : l.feature.properties.href,
          country : l.feature.properties.name.split("_")[1],
          bbox : l.feature.bbox
        })
    });

    var requestDiv = d3.select("#request-wrapper");

    requestDiv.select("#make-request")
      .style("display","block")
      .selectAll(".name").text(metro.properties.name);

    if (encompassed[0].metros.length){
      requestDiv.attr("class","encompassed");
      drawList(encompassed, geoID, metro.properties.name);
      return;
    }

    var biggestDist = Math.max(requestBoundingBox[1][1] - requestBoundingBox[0][1], requestBoundingBox[1][0] - requestBoundingBox[0][0]);
    if (biggestDist > 5)
      requestDiv.attr("class","request-greater-5");
    else if (biggestDist > 1)
      requestDiv.attr("class","request-greater-1");
    else
      requestDiv.attr("class","default");
  }
  function drawRequestBox() {
    clearMap();
    rect = new L.Rectangle(new L.LatLngBounds(requestBoundingBox), { className : "blue" });
    displayMap.addLayer(rect);

    var cSW = new L.marker(requestBoundingBox[0], { icon : myIcon, draggable: true });
    dots.push(cSW);
    var cNE = new L.marker(requestBoundingBox[1], { icon : myIcon, draggable: true });
    dots.push(cNE);

    cSW.on("drag",function(e){
      requestBoundingBox[0] = [e.target.getLatLng().lat, e.target.getLatLng().lng];
      redrawBox();
    });
    cNE.on("drag",function(e){
      requestBoundingBox[1] = [e.target.getLatLng().lat, e.target.getLatLng().lng];
      redrawBox();
    });

    dots.forEach(function(l){
      displayMap.addLayer(l);
    });
    fillRequestForm();
  }
  function redrawBox() {
    displayMap.removeLayer(rect);
    rect = new L.Rectangle(new L.LatLngBounds(requestBoundingBox), { className : "blue" });
    displayMap.addLayer(rect);
    fillRequestForm();
  }
  function clearMap() {
    if (rect) displayMap.removeLayer(rect);
    if (outline) displayMap.removeLayer(outline);
    dots.forEach(function(l){
      displayMap.removeLayer(l);
    });
    dots = [];
  }
  function clearRequest() {
    clearMap();
    d3.select("#did-you-mean").style("display","none");
    d3.select("#make-request").style("display","none");
    d3.selectAll(".encompassed-text").style("display","none");
  }

  function fillRequestForm() {
    d3.select("input[name='bbox_n']").attr("value",requestBoundingBox[1][0]);
    d3.select("input[name='bbox_w']").attr("value",requestBoundingBox[0][1]);
    d3.select("input[name='bbox_s']").attr("value",requestBoundingBox[0][0]);
    d3.select("input[name='bbox_e']").attr("value",requestBoundingBox[1][1]);
  }

  var keyIndex = -1,
    placeID = null;

  d3.select("#search_submit").on("click",function(){
    var val = document.getElementById("search_input").value;
    if (val.length)
      onSubmit(val);
  });

  d3.select("#search_input").on("keyup",function(){
    var inputDiv = document.getElementById("search_input");
    var val = inputDiv.value;

    if (!val.length) {
      drawList(nestedCities);
      d3.selectAll(".suggestion").remove();
      placeID = null;
      clearRequest();
      return;
    }

    if (event.keyCode == 40) { //arrow down
      keyIndex = Math.min(keyIndex+1, d3.selectAll(".suggestion")[0].length-1);
      selectSuggestion();   
    } else if (event.keyCode == 38) { //arrow up
      keyIndex = Math.max(keyIndex-1, 0);
      selectSuggestion();
    } else if (event.keyCode == 13) { //enter
      onSubmit(val);
    } else if (event.keyCode != 8 && (event.keyCode < 48 || event.keyCode > 90)) {
      return; //restrict autocomplete to 0-9,a-z character input, excluding delete
    } else {
      keyIndex = -1;
      placeID = null;
      doSuggestion(val);
      filterList(val);
    }
  });

  function selectSuggestion() {
    var currentList = d3.selectAll(".suggestion");
    currentList.each(function(d, i){ 
      if (i == keyIndex) {
        document.getElementById("search_input").value = d.properties.label;
        placeID = d.properties.source + ":" + d.properties.layer + ":" + d.properties.id;
      }
    }).classed("selected",function(d,i){ return i == keyIndex; });
  }

  function onSubmit(val) {
    keyIndex = -1;
    filterList(val);
    d3.selectAll(".suggestion").remove();
    doSearch(val);
    placeID = null;
  }

  function filterList(str) {
    var newData = [];
    str = str.toLowerCase();
    nestedCities.forEach(function(d){
      if (d.country.toLowerCase().indexOf(str) != -1) {
        newData.push(d);
      } else {
        var c = {
          country : d.country,
          metros : []
        }
        d.metros.forEach(function(e){ 
          if (e.name.toLowerCase().indexOf(str) != -1)
            c.metros.push(e);
        });
        if (c.metros.length) newData.push(c);
      }
    });
    drawList(newData);
  }
{% endblock %}